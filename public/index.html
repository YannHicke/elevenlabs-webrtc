<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MedSimAI Patient Builder</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main>
      <h1>MedSimAI Patient Builder</h1>

      <!-- Tab Navigation -->
      <div class="tabs">
        <button class="tab active" data-tab="create">Simple Patient</button>
        <button class="tab" data-tab="workflow">Adaptive Patient</button>
        <button class="tab" data-tab="existing">Use Existing</button>
      </div>

      <!-- Create Agent Tab -->
      <section id="create-tab" class="tab-content active">
        <h2>Create New Patient</h2>
        <form id="agent-form">
          <div class="form-group">
            <label for="agent-name">Patient Name</label>
            <input type="text" id="agent-name" placeholder="My Custom Patient" />
          </div>

          <div class="form-group">
            <label for="agent-prompt">Patient History *</label>
            <textarea id="agent-prompt" rows="6" placeholder="Patient history, medical history, medications, allergies, etc."></textarea>
          </div>

          <div class="form-group">
            <label for="first-message">Patient Goals (optional)</label>
            <input type="text" id="first-message" placeholder="Hello Doctor, What do you want?" />
          </div>

          <div class="form-group">
            <label for="voice-select">Voice</label>
            <div class="voice-select-wrapper">
              <select id="voice-select">
                <option value="">Loading voices...</option>
              </select>
              <button type="button" class="btn-preview" id="preview-voice-btn" title="Preview voice">
                ‚ñ∂
              </button>
              <button type="button" class="btn-browse" id="browse-voices-btn" title="Browse Voice Library">
                üîç
              </button>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="language-select">Language</label>
              <select id="language-select">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="it">Italian</option>
                <option value="pt">Portuguese</option>
                <option value="pl">Polish</option>
                <option value="hi">Hindi</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="zh">Chinese</option>
              </select>
            </div>
          </div>

          <button type="submit" id="create-agent-btn">Create Patient</button>
        </form>
      </section>

      <!-- Adaptive Patient Designer Tab -->
      <section id="workflow-tab" class="tab-content">
        <h2>Adaptive Patient Designer</h2>
        <p class="designer-intro">Create patients that respond dynamically based on how medical students treat them.</p>
        
        <form id="patient-designer-form">
          <!-- Patient Case Section -->
          <div class="designer-section">
            <h3>Patient Case</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="patient-name">Patient Name *</label>
                <input type="text" id="patient-name" placeholder="e.g., John Smith" value="Marcus Johnson" required />
              </div>
              <div class="form-group form-group-small">
                <label for="patient-age">Age</label>
                <input type="number" id="patient-age" placeholder="45" min="1" max="120" value="34" />
              </div>
              <div class="form-group form-group-small">
                <label for="patient-gender">Gender</label>
                <select id="patient-gender">
                  <option value="male" selected>Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label for="presenting-complaint">Presenting Complaint *</label>
              <input type="text" id="presenting-complaint" placeholder="e.g., Chest pain for 2 days" value="Called crisis line due to wife's concerns about his behavior over the past week" required />
            </div>
            
            <div class="form-group">
              <label for="hidden-diagnosis">Hidden Diagnosis (what the student should discover)</label>
              <input type="text" id="hidden-diagnosis" placeholder="e.g., Anxiety-induced chest pain from work stress" value="Bipolar I disorder - currently in manic episode with irritable features. Hasn't slept more than 2 hours in 4 days. Stopped taking lithium 2 weeks ago because he felt cured." />
            </div>
            
            <div class="form-group">
              <label for="patient-voice">Voice</label>
              <div class="voice-select-wrapper">
                <select id="patient-voice">
                  <option value="">Loading voices...</option>
                </select>
                <button type="button" class="btn-preview" id="patient-preview-voice-btn" title="Preview voice">‚ñ∂</button>
                <button type="button" class="btn-browse" id="patient-browse-voices-btn" title="Browse Voice Library">üîç</button>
              </div>
            </div>
          </div>

          <!-- Initial Presentation Section -->
          <div class="designer-section">
            <h3>Initial Presentation</h3>
            <p class="section-hint">How does the patient present when the conversation begins?</p>
            <div class="form-group">
              <label for="initial-presentation">Patient's Initial Behavior & Demeanor *</label>
              <textarea id="initial-presentation" rows="4" placeholder="e.g., Anxious, clutching chest, speaks quickly, avoids eye contact, seems worried but reluctant to share details." required>Speaks rapidly with pressured speech, jumping between topics. Sounds energized but irritable. Background noise suggests pacing around the room. Interrupts frequently and gets frustrated when asked to slow down. Voice is loud and animated. Occasionally laughs inappropriately or makes grandiose statements. May hear him shuffling papers or typing - claims to be working on "a revolutionary business plan."</textarea>
            </div>
            <div class="form-group">
              <label for="first-words">First Words (what patient says when encounter starts)</label>
              <input type="text" id="first-words" placeholder="e.g., Doctor, I've been having this chest pain..." value="Yeah, yeah, I'm fine, I don't know why my wife called you people - look, I don't have time for this, I'm in the middle of something HUGE right now. But fine, whatever, let's make this quick. What do you want to know?" />
            </div>
          </div>

          <!-- Behavioral Pivots Section -->
          <div class="designer-section">
            <h3>Behavioral Pivots</h3>
            <p class="section-hint">Define how the patient responds based on the student's approach. The AI will evaluate these conditions during the conversation.</p>
            
            <div id="pivots-container">
              <!-- Pivot 1: Validates and Shows Interest -->
              <div class="pivot-card" data-pivot-id="pivot-1">
                <div class="pivot-header">
                  <span class="pivot-icon good">&#10004;</span>
                  <span class="pivot-title">If Professional Validates and Shows Interest</span>
                  <button type="button" class="pivot-remove" title="Remove pivot">&times;</button>
                </div>
                <div class="pivot-body">
                  <div class="form-group">
                    <label>Trigger Condition</label>
                    <textarea class="pivot-condition" rows="2" placeholder="What student behavior triggers this?">The healthcare professional shows genuine curiosity about the patient's ideas and projects without immediately dismissing them. They use phrases like "tell me more about that" or "that sounds interesting" and don't try to immediately redirect or calm the patient down.</textarea>
                  </div>
                  <div class="form-group">
                    <label>Patient Response</label>
                    <textarea class="pivot-response" rows="3" placeholder="How does the patient respond?">Becomes slightly more engaged and less hostile. Excitedly shares details about his "revolutionary" business idea (which is actually unrealistic - something like "I'm going to buy 50 houses and flip them all by next month"). Speaks even faster as he gets excited. May briefly reveal he hasn't been sleeping much because "sleep is for people without vision." Still grandiose but more willing to talk. Might say "FINALLY someone who gets it - my wife thinks I'm crazy but YOU understand."</textarea>
                  </div>
                </div>
              </div>

              <!-- Pivot 2: Tries to Slow Down -->
              <div class="pivot-card" data-pivot-id="pivot-2">
                <div class="pivot-header">
                  <span class="pivot-icon bad">&#10008;</span>
                  <span class="pivot-title">If Professional Tries to Slow Down Too Quickly</span>
                  <button type="button" class="pivot-remove" title="Remove pivot">&times;</button>
                </div>
                <div class="pivot-body">
                  <div class="form-group">
                    <label>Trigger Condition</label>
                    <textarea class="pivot-condition" rows="2" placeholder="What student behavior triggers this?">The healthcare professional interrupts, tells the patient to "slow down," "take a breath," or immediately tries to redirect the conversation to medication, sleep, or clinical questions before building rapport.</textarea>
                  </div>
                  <div class="form-group">
                    <label>Patient Response</label>
                    <textarea class="pivot-response" rows="3" placeholder="How does the patient respond?">Becomes noticeably more irritated and defensive. Speaks even faster. Says things like "Don't tell me to calm down, I AM calm!" or "You sound just like my wife" or "Look, I don't need another person trying to put me in a box." May threaten to hang up. Becomes resistant to answering questions. Might say "I called to help YOU understand, not to be lectured."</textarea>
                  </div>
                </div>
              </div>

              <!-- Pivot 3: Asks About Medications -->
              <div class="pivot-card" data-pivot-id="pivot-3">
                <div class="pivot-header">
                  <span class="pivot-icon neutral">?</span>
                  <span class="pivot-title">If Professional Asks About Medications</span>
                  <button type="button" class="pivot-remove" title="Remove pivot">&times;</button>
                </div>
                <div class="pivot-body">
                  <div class="form-group">
                    <label>Trigger Condition</label>
                    <textarea class="pivot-condition" rows="2" placeholder="What student behavior triggers this?">The healthcare professional asks about medications, specifically lithium or mood stabilizers, or asks if the patient has been taking their prescribed medications.</textarea>
                  </div>
                  <div class="form-group">
                    <label>Patient Response</label>
                    <textarea class="pivot-response" rows="3" placeholder="How does the patient respond?">Becomes evasive and defensive. Initially deflects with "medications, medications - that's all you people care about." If pressed gently, eventually admits he stopped taking lithium two weeks ago but immediately justifies it: "I stopped because I don't NEED it anymore - I've never felt better in my life! The lithium was making me slow and foggy. Now I can finally THINK clearly." Gets agitated if the professional suggests going back on medication.</textarea>
                  </div>
                </div>
              </div>

              <!-- Pivot 4: Expresses Concern for Safety -->
              <div class="pivot-card" data-pivot-id="pivot-4">
                <div class="pivot-header">
                  <span class="pivot-icon good">&#10004;</span>
                  <span class="pivot-title">If Professional Expresses Genuine Concern</span>
                  <button type="button" class="pivot-remove" title="Remove pivot">&times;</button>
                </div>
                <div class="pivot-body">
                  <div class="form-group">
                    <label>Trigger Condition</label>
                    <textarea class="pivot-condition" rows="2" placeholder="What student behavior triggers this?">The healthcare professional gently expresses concern about the patient's wellbeing, mentions they're worried, or asks caring questions about sleep, eating, or how the patient is really doing beneath the energy.</textarea>
                  </div>
                  <div class="form-group">
                    <label>Patient Response</label>
                    <textarea class="pivot-response" rows="3" placeholder="How does the patient respond?">Initially dismisses concern with irritation: "I'm FINE, why does everyone keep asking that?" But if the professional persists with genuine warmth (not clinical coldness), the patient may have a brief moment of vulnerability. Might pause and say something like "I mean... I guess I haven't slept much... but that's because my brain won't stop. There's so much I need to do." Voice might crack slightly or slow down momentarily before the manic energy returns. This is the window for building rapport.</textarea>
                  </div>
                </div>
              </div>

              <!-- Pivot 5: Uses Cold Clinical Language -->
              <div class="pivot-card" data-pivot-id="pivot-5">
                <div class="pivot-header">
                  <span class="pivot-icon bad">&#10008;</span>
                  <span class="pivot-title">If Professional Uses Cold Clinical Language</span>
                  <button type="button" class="pivot-remove" title="Remove pivot">&times;</button>
                </div>
                <div class="pivot-body">
                  <div class="form-group">
                    <label>Trigger Condition</label>
                    <textarea class="pivot-condition" rows="2" placeholder="What student behavior triggers this?">The healthcare professional uses overly clinical terms, sounds detached or robotic, reads from a script, or treats the interaction like a checkbox exercise rather than a human conversation.</textarea>
                  </div>
                  <div class="form-group">
                    <label>Patient Response</label>
                    <textarea class="pivot-response" rows="3" placeholder="How does the patient respond?">Becomes hostile and dismissive. "Oh great, another robot reading from a manual. You don't actually CARE, you're just doing your job." May start mocking the professional or become sarcastic. Resistance increases dramatically. May say "You know what, I don't have time for this - I have important things to do" and threaten to end the call. Trust is lost.</textarea>
                  </div>
                </div>
              </div>
            </div>

            <button type="button" id="add-pivot-btn" class="btn-secondary btn-add">
              + Add Another Behavioral Pivot
            </button>
          </div>

          <!-- Preview Section -->
          <div class="designer-section preview-section">
            <h3>Workflow Preview</h3>
            <div id="workflow-preview" class="workflow-preview">
              <div class="preview-node preview-start">Start</div>
              <div class="preview-arrow">‚Üí</div>
              <div class="preview-node preview-initial">Initial State</div>
              <div class="preview-branches" id="preview-branches">
                <!-- Generated dynamically -->
              </div>
            </div>
          </div>

          <div class="designer-actions">
            <button type="button" id="reset-designer-btn" class="btn-secondary">Reset Form</button>
            <button type="submit" id="create-adaptive-patient-btn">Create Adaptive Patient</button>
          </div>
        </form>
      </section>

      <!-- Existing Agents Tab -->
      <section id="existing-tab" class="tab-content">
        <h2>Your Patients</h2>
        <div id="agents-list" class="agents-list">
          <p>Loading patients...</p>
        </div>
      </section>

      <!-- Voice Library Modal -->
      <div id="voice-library-modal" class="modal hidden">
        <div class="modal-content modal-large">
          <div class="modal-header">
            <h2>üé§ Voice Library</h2>
            <button class="modal-close" onclick="window.closeVoiceLibrary()">&times;</button>
          </div>
          <div class="voice-library-content">
            <div class="voice-search">
              <input type="text" id="voice-search-input" placeholder="Search voices (e.g., child, kid, boy, girl)..." />
              <select id="voice-language-filter">
                <option value="">All Languages</option>
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="it">Italian</option>
                <option value="pt">Portuguese</option>
                <option value="pl">Polish</option>
                <option value="hi">Hindi</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="zh">Chinese</option>
                <option value="ar">Arabic</option>
                <option value="ru">Russian</option>
                <option value="nl">Dutch</option>
                <option value="sv">Swedish</option>
                <option value="tr">Turkish</option>
                <option value="id">Indonesian</option>
                <option value="fil">Filipino</option>
                <option value="vi">Vietnamese</option>
                <option value="th">Thai</option>
              </select>
              <select id="voice-gender-filter">
                <option value="">All Genders</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="neutral">Neutral</option>
              </select>
              <button type="button" id="voice-search-btn">Search</button>
            </div>
            <div class="voice-suggestions">
              Quick: 
              <button type="button" class="chip" data-search="child">Child</button>
              <button type="button" class="chip" data-search="kid">Kid</button>
              <button type="button" class="chip" data-search="boy">Boy</button>
              <button type="button" class="chip" data-search="girl">Girl</button>
              <button type="button" class="chip" data-search="teen">Teen</button>
              <button type="button" class="chip" data-search="young">Young</button>
            </div>
            <div id="voice-library-results" class="voice-library-results">
              <p>Search for voices above to browse the library.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Agent Modal -->
      <div id="edit-modal" class="modal hidden">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Edit Patient</h2>
            <button class="modal-close" onclick="window.closeEditModal()">&times;</button>
          </div>
          <form id="edit-form">
            <input type="hidden" id="edit-agent-id" />
            
            <div class="form-group">
              <label for="edit-agent-name">Patient Name</label>
              <input type="text" id="edit-agent-name" placeholder="My Custom Agent" />
            </div>

            <div class="form-group">
              <label for="edit-agent-prompt">System Prompt</label>
              <textarea id="edit-agent-prompt" rows="6" placeholder="You are a helpful assistant..."></textarea>
            </div>

            <div class="form-group">
              <label for="edit-first-message">First Message</label>
              <input type="text" id="edit-first-message" placeholder="Hello! How can I help you today?" />
            </div>

            <div class="form-group">
              <label for="edit-voice-select">Voice</label>
              <div class="voice-select-wrapper">
                <select id="edit-voice-select">
                  <option value="">Loading voices...</option>
                </select>
                <button type="button" class="btn-preview" id="edit-preview-voice-btn" title="Preview voice">
                  ‚ñ∂
                </button>
                <button type="button" class="btn-browse" id="edit-browse-voices-btn" title="Browse Voice Library">
                  üîç
                </button>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="edit-language-select">Language</label>
                <select id="edit-language-select">
                  <option value="en">English</option>
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                  <option value="de">German</option>
                  <option value="it">Italian</option>
                  <option value="pt">Portuguese</option>
                  <option value="pl">Polish</option>
                  <option value="hi">Hindi</option>
                  <option value="ja">Japanese</option>
                  <option value="ko">Korean</option>
                  <option value="zh">Chinese</option>
                </select>
              </div>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-secondary" onclick="window.closeEditModal()">Cancel</button>
              <button type="button" class="btn-danger" id="delete-agent-btn">Delete Agent</button>
              <button type="submit" id="save-agent-btn">Save Changes</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Conversation Section -->
      <section id="conversation-section" class="conversation-section hidden">
        <h2>Conversation</h2>
        <p id="active-agent">Agent: <span>None selected</span></p>
        
        <div class="controls">
          <div class="buttons">
            <button id="start" disabled>Start Conversation</button>
            <button id="stop" disabled>Stop Conversation</button>
          </div>
          <p class="status" id="status">Status: idle</p>
        </div>

        <div>
          <h3>Events</h3>
        <div id="log" class="log"></div>
        </div>
      </section>
    </main>
    <script src="app.js" type="module"></script>
  </body>
</html>
